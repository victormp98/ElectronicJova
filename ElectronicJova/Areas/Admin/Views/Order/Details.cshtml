@using ElectronicJova.Models
@using ElectronicJova.Utilities
@model OrderDetailsVM

@{
    ViewData["Title"] = $"Pedido #{Model.OrderHeader?.Id} — Admin";
    var SD_Admin = SD.Role_Admin;
}

<div class="container-fluid py-4">

    <!-- ── Header ───────────────────────────────────────── -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold mb-0">
                Pedido <span style="color: var(--accent-cyan);">#@Model.OrderHeader?.Id</span>
            </h2>
            <small class="text-muted">@Model.OrderHeader?.OrderDate.ToString("dddd, dd MMMM yyyy HH:mm")</small>
        </div>
        <a asp-action="Index" class="btn btn-outline-secondary rounded-pill">
            <i class="bi bi-arrow-left me-1"></i> Volver a Pedidos
        </a>
    </div>

    <form method="post" asp-action="UpdateOrderDetail">
        <input asp-for="OrderHeader.Id" hidden />

        <div class="row g-4">
            <!-- ── Shipping Details ──────────────────────── -->
            <div class="col-lg-7">
                <div class="card border-0 shadow-sm h-100" style="background: var(--bg-card); border: 1px solid var(--border-color) !important;">
                    <div class="card-header border-0 py-3" style="background: rgba(0,212,255,0.05); border-bottom: 1px solid var(--border-color) !important;">
                        <h6 class="fw-bold mb-0" style="color: var(--accent-cyan);">
                            <i class="bi bi-geo-alt-fill me-2"></i>Datos de Envío
                        </h6>
                    </div>
                    <div class="card-body">
                        @{
                            var isAdmin = User.IsInRole(SD_Admin);
                            var fields = new[]
                            {
                                ("Nombre",          "OrderHeader.Name",          Model.OrderHeader?.Name,          false),
                                ("Teléfono",        "OrderHeader.PhoneNumber",   Model.OrderHeader?.PhoneNumber,   false),
                                ("Dirección",       "OrderHeader.StreetAddress", Model.OrderHeader?.StreetAddress, false),
                                ("Ciudad",          "OrderHeader.City",          Model.OrderHeader?.City,          false),
                                ("Estado",          "OrderHeader.State",         Model.OrderHeader?.State,         false),
                                ("Código Postal",   "OrderHeader.PostalCode",    Model.OrderHeader?.PostalCode,    false),
                                ("Núm. Rastreo",    "OrderHeader.TrackingNumber",Model.OrderHeader?.TrackingNumber,true),
                                ("Transportista",   "OrderHeader.Carrier",       Model.OrderHeader?.Carrier,       true),
                            };
                        }

                        @foreach (var (label, aspFor, val, adminOnly) in fields)
                        {
                            <div class="row align-items-center mb-2">
                                <div class="col-4">
                                    <label class="form-label text-muted small mb-0">@label</label>
                                </div>
                                <div class="col-8">
                                    @if (isAdmin || !adminOnly)
                                    {
                                        <input name="@aspFor" value="@val" class="form-control form-control-sm"
                                               style="background: var(--bg-input); border-color: var(--border-color); color: var(--text-primary);"
                                               @(isAdmin ? "" : "readonly") />
                                    }
                                    else
                                    {
                                        <input value="@val" class="form-control form-control-sm" readonly
                                               style="background: var(--bg-input); border-color: var(--border-color); color: var(--text-primary);" />
                                    }
                                </div>
                            </div>
                        }

                        <!-- Order Date (readonly) -->
                        <div class="row align-items-center mb-2">
                            <div class="col-4">
                                <label class="form-label text-muted small mb-0">Fecha Pedido</label>
                            </div>
                            <div class="col-8">
                                <input value="@Model.OrderHeader?.OrderDate.ToShortDateString()" class="form-control form-control-sm" readonly
                                       style="background: var(--bg-input); border-color: var(--border-color); color: var(--text-primary);" />
                            </div>
                        </div>

                        <!-- Order Status -->
                        <div class="row align-items-center mb-2">
                            <div class="col-4">
                                <label class="form-label text-muted small mb-0">Estado</label>
                            </div>
                            <div class="col-8">
                                @if (isAdmin)
                                {
                                    <select name="OrderHeader.OrderStatus" class="form-select form-select-sm"
                                            style="background: var(--bg-input); border-color: var(--border-color); color: var(--text-primary);">
                                        @foreach (var s in new[] { SD.StatusPending, SD.StatusApproved, SD.StatusInProcess, SD.StatusShipped, SD.StatusDelivered, SD.StatusCancelled })
                                        {
                                            <option value="@s" selected="@(Model.OrderHeader?.OrderStatus == s)">@SD.GetOrderStatusLabel(s)</option>
                                        }
                                    </select>
                                }
                                else
                                {
                                    <input value="@SD.GetOrderStatusLabel(Model.OrderHeader?.OrderStatus ?? "")" class="form-control form-control-sm" readonly
                                           style="background: var(--bg-input); border-color: var(--border-color); color: var(--text-primary);" />
                                }
                            </div>
                        </div>

                        <!-- Payment Status -->
                        <div class="row align-items-center mb-2">
                            <div class="col-4">
                                <label class="form-label text-muted small mb-0">Pago</label>
                            </div>
                            <div class="col-8">
                                <input value="@Model.OrderHeader?.PaymentStatus" class="form-control form-control-sm" readonly
                                       style="background: var(--bg-input); border-color: var(--border-color); color: var(--text-primary);" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ── Order Summary & Actions ───────────────── -->
            <div class="col-lg-5">
                <div class="card border-0 shadow-sm mb-4" style="background: var(--bg-card); border: 1px solid var(--border-color) !important;">
                    <div class="card-header border-0 py-3" style="background: rgba(0,212,255,0.05); border-bottom: 1px solid var(--border-color) !important;">
                        <h6 class="fw-bold mb-0" style="color: var(--accent-cyan);">
                            <i class="bi bi-receipt me-2"></i>Resumen del Pedido
                        </h6>
                    </div>
                    <div class="card-body p-0">
                        <ul class="list-group list-group-flush">
                            @foreach (var item in Model.OrderDetail)
                            {
                                <li class="list-group-item d-flex justify-content-between align-items-start py-3"
                                    style="background: transparent; border-color: var(--border-color); color: var(--text-primary);">
                                    <div class="flex-grow-1">
                                        <div class="fw-semibold">@item.Product?.Title</div>
                                        <small class="text-muted">Cant: @item.Count &nbsp;·&nbsp; @item.Price.ToString("c") c/u</small>

                                        @if (!string.IsNullOrEmpty(item.SelectedOptions))
                                        {
                                            var opts = System.Text.Json.JsonSerializer.Deserialize<List<dynamic>>(item.SelectedOptions);
                                            <div class="mt-1">
                                                @foreach (var opt in opts!)
                                                {
                                                    <span class="badge me-1" style="background: rgba(0,212,255,0.15); color: var(--accent-cyan); font-size: 0.7rem;">
                                                        @opt.GetProperty("Name"): @opt.GetProperty("Value")
                                                    </span>
                                                }
                                            </div>
                                        }

                                        @if (!string.IsNullOrEmpty(item.SpecialNotes))
                                        {
                                            <div class="mt-1 p-2 rounded" style="background: rgba(255,193,7,0.1); border-left: 3px solid #ffc107;">
                                                <small class="text-warning-emphasis">Nota: @item.SpecialNotes</small>
                                            </div>
                                        }
                                    </div>
                                    <span class="fw-bold ms-3" style="color: var(--accent-cyan);">
                                        @((item.Count * item.Price).ToString("c"))
                                    </span>
                                </li>
                            }
                            <li class="list-group-item d-flex justify-content-between py-3"
                                style="background: rgba(0,212,255,0.05); border-color: var(--border-color);">
                                <strong style="color: var(--text-primary);">Total</strong>
                                <strong style="color: var(--accent-cyan); font-size: 1.1rem;">
                                    @Model.OrderHeader?.OrderTotal.ToString("c")
                                </strong>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- Admin Action Buttons -->
                @if (isAdmin)
                {
                    <div class="card border-0 shadow-sm" style="background: var(--bg-card); border: 1px solid var(--border-color) !important;">
                        <div class="card-header border-0 py-3" style="background: rgba(0,212,255,0.05); border-bottom: 1px solid var(--border-color) !important;">
                            <h6 class="fw-bold mb-0 text-muted"><i class="bi bi-sliders me-2"></i>Acciones</h6>
                        </div>
                        <div class="card-body d-grid gap-2">
                            @if (Model.OrderHeader?.OrderStatus == SD.StatusPending || Model.OrderHeader?.OrderStatus == SD.PaymentStatusApproved)
                            {
                                <button type="submit" asp-action="UpdateOrderDetail" class="btn btn-warning">
                                    <i class="bi bi-pencil-square me-1"></i>Actualizar Detalles
                                </button>
                            }
                            @if (Model.OrderHeader?.OrderStatus == SD.StatusPending || Model.OrderHeader?.OrderStatus == SD.StatusApproved)
                            {
                                <button type="submit" asp-action="StartProcessing" class="btn btn-primary">
                                    <i class="bi bi-gear me-1"></i>Iniciar Proceso
                                </button>
                            }
                            @if (Model.OrderHeader?.OrderStatus == SD.StatusInProcess)
                            {
                                <button type="submit" asp-action="ShipOrder" class="btn btn-info text-white">
                                    <i class="bi bi-truck me-1"></i>Marcar como Enviado
                                </button>
                            }
                            @if (Model.OrderHeader?.OrderStatus != SD.StatusCancelled && Model.OrderHeader?.OrderStatus != SD.StatusShipped && Model.OrderHeader?.OrderStatus != SD.StatusDelivered)
                            {
                                <button type="submit" asp-action="CancelOrder" class="btn btn-outline-danger">
                                    <i class="bi bi-x-circle me-1"></i>Cancelar Pedido
                                </button>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>
    </form>
</div>

@section Scripts {
    @{
        <partial name="_ValidationScriptsPartial" />
    }
}
