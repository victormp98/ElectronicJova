@model ElectronicJova.Models.OrderHeader
@using ElectronicJova.Utilities
@using ElectronicJova.Models

@{
    ViewData["Title"] = $"Pedido #{Model.Id}";
    var orderDetails = ViewBag.OrderDetails as IEnumerable<OrderDetail> ?? Enumerable.Empty<OrderDetail>();
    var statusEnum = SD.ParseOrderStatus(Model.OrderStatus);
    var isCancelled = Model.OrderStatus == SD.StatusCancelled;

    // Steps for progress bar (excluding Cancelled)
    var steps = new[]
    {
        (SD.OrderStatus.Pending,    SD.StatusPending,    "Pendiente",    "bi-clock"),
        (SD.OrderStatus.Approved,   SD.StatusApproved,   "Pagado",       "bi-credit-card-2-front"),
        (SD.OrderStatus.Processing, SD.StatusInProcess,  "En Proceso",   "bi-gear"),
        (SD.OrderStatus.Shipped,    SD.StatusShipped,    "Enviado",      "bi-truck"),
        (SD.OrderStatus.Delivered,  SD.StatusDelivered,  "Entregado",    "bi-check-circle"),
    };
}

<div class="container py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold mb-0">Pedido <span class="text-primary">#@Model.Id</span></h2>
            <small class="text-muted">@Model.OrderDate.ToString("dddd, dd MMMM yyyy HH:mm")</small>
        </div>
        <a asp-action="Index" class="btn btn-outline-secondary rounded-pill">
            <i class="bi bi-arrow-left me-1"></i>Mis Pedidos
        </a>
    </div>

    @if (isCancelled)
    {
        <div class="alert alert-danger d-flex align-items-center mb-4" role="alert">
            <i class="bi bi-x-circle-fill me-2 fs-4"></i>
            <div><strong>Pedido Cancelado.</strong> Si realizaste un pago, el reembolso se procesará en 5-10 días hábiles.</div>
        </div>
    }
    else
    {
        <!-- ── Barra de Progreso ── -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body py-4">
                <h6 class="text-muted mb-4 text-uppercase fw-semibold">Estado del Pedido</h6>

                <!-- Notificación en tiempo real -->
                <div id="realtime-alert" class="alert alert-info d-none mb-3" role="alert">
                    <i class="bi bi-lightning-charge-fill me-2"></i>
                    <span id="realtime-message">Conectando...</span>
                </div>

                <div class="d-flex justify-content-between align-items-start position-relative mb-2 overflow-x-auto pb-2 flex-nowrap" style="scrollbar-width: none; -ms-overflow-style: none;">
                    <!-- Línea de fondo -->
                    <div class="position-absolute top-50 start-0 end-0 translate-middle-y d-none d-md-block"
                         style="height: 3px; background: #e9ecef; z-index: 0; margin: 0 40px;"></div>

                    @for (int i = 0; i < steps.Length; i++)
                    {
                        var (stepEnum, _, label, icon) = steps[i];
                        var isCompleted = (int)statusEnum >= (int)stepEnum;
                        var isCurrent = statusEnum == stepEnum;

                        var circleClass = isCompleted ? "bg-primary text-white" : "bg-light text-muted border";
                        var textClass = isCompleted ? "text-primary fw-semibold" : "text-muted";

                        <div class="d-flex flex-column align-items-center flex-shrink-0" style="z-index: 1; min-width: 100px;">
                            <div class="rounded-circle d-flex align-items-center justify-content-center @circleClass @(isCurrent ? "shadow" : "")"
                                 style="width: 48px; height: 48px; font-size: 1.2rem; @(isCurrent ? "box-shadow: 0 0 0 4px rgba(13,110,253,0.2) !important;" : "")">
                                <i class="bi @icon"></i>
                            </div>
                            <small class="mt-2 text-center @textClass" style="font-size: 0.75rem;">@label</small>
                        </div>
                    }
                </div>
            </div>
        </div>
    }

    <div class="row g-4">
        <!-- Productos -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent border-0 pt-3">
                    <h6 class="fw-bold mb-0"><i class="bi bi-box-seam me-2"></i>Productos</h6>
                </div>
                <div class="card-body">
                    @foreach (var detail in orderDetails)
                    {
                        <div class="d-flex align-items-center py-2 border-bottom">
                            <img src="@(string.IsNullOrEmpty(detail.Product?.ImageUrl) ? "https://via.placeholder.com/60" : detail.Product.ImageUrl)"
                                 width="60" height="60" class="rounded me-3" style="object-fit: cover;" />
                            <div class="flex-grow-1">
                                <div class="fw-semibold">@detail.Product?.Title</div>
                                <small class="text-muted">Cantidad: @detail.Count</small>

                                @if (!string.IsNullOrEmpty(detail.SelectedOptions))
                                {
                                    var opts = System.Text.Json.JsonSerializer.Deserialize<List<dynamic>>(detail.SelectedOptions);
                                    <div class="mt-1">
                                        @foreach (var opt in opts)
                                        {
                                            <span class="badge bg-light text-primary border me-1" style="font-size: 0.7rem;">
                                                @opt.GetProperty("Name"): @opt.GetProperty("Value")
                                            </span>
                                        }
                                    </div>
                                }

                                @if (!string.IsNullOrEmpty(detail.SpecialNotes))
                                {
                                    <div class="mt-1 small text-muted">
                                        <i class="bi bi-sticky-fill text-warning me-1"></i>Nota: @detail.SpecialNotes
                                    </div>
                                }
                            </div>
                            <div class="text-end">
                                <div class="fw-bold text-primary">@((detail.Price * detail.Count).ToString("c"))</div>
                                <small class="text-muted">@detail.Price.ToString("c") c/u</small>
                            </div>
                        </div>
                    }
                    <div class="d-flex justify-content-between pt-3">
                        <strong>Total del Pedido</strong>
                        <strong class="text-primary fs-5">@Model.OrderTotal.ToString("c")</strong>
                    </div>
                </div>
            </div>
        </div>

        <!-- Info de envío -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent border-0 pt-3">
                    <h6 class="fw-bold mb-0"><i class="bi bi-geo-alt me-2"></i>Información de Envío</h6>
                </div>
                <div class="card-body">
                    <p class="mb-1"><strong>@Model.Name</strong></p>
                    <p class="mb-1 text-muted">@Model.StreetAddress</p>
                    <p class="mb-1 text-muted">@Model.City, @Model.State @Model.PostalCode</p>
                    <p class="mb-1 text-muted"><i class="bi bi-telephone me-1"></i>@Model.PhoneNumber</p>
                    @if (!string.IsNullOrEmpty(Model.TrackingNumber))
                    {
                        <hr />
                        <p class="mb-1"><strong>Número de Rastreo:</strong></p>
                        <p class="text-primary fw-semibold">@Model.TrackingNumber</p>
                        <p class="mb-0 text-muted">Transportista: @Model.Carrier</p>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/lib/microsoft/signalr/dist/browser/signalr.min.js"></script>
    <script>
        const orderId = "@Model.Id";
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/hubs/orderStatus")
            .withAutomaticReconnect()
            .build();

        connection.on("OrderStatusUpdated", function (newStatus, newLabel, newIcon) {
            // Mostrar alerta de actualización
            const alert = document.getElementById("realtime-alert");
            const msg = document.getElementById("realtime-message");
            if (alert && msg) {
                msg.textContent = `Estado actualizado: ${newLabel}`;
                alert.classList.remove("d-none");
                // Recargar la página después de 2 segundos para mostrar la nueva barra
                setTimeout(() => location.reload(), 2000);
            }
        });

        connection.start()
            .then(() => connection.invoke("SubscribeToOrder", orderId))
            .catch(err => console.error("SignalR error:", err));
    </script>
}
