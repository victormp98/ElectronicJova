@model ElectronicJova.Models.OrderHeader
@using ElectronicJova.Utilities
@using ElectronicJova.Models

@{
    ViewData["Title"] = $"Pedido #{Model.Id}";
    var orderDetails = ViewBag.OrderDetails as IEnumerable<OrderDetail> ?? Enumerable.Empty<OrderDetail>();
    var statusLogs = ViewBag.StatusLogs as IEnumerable<OrderStatusLog> ?? Enumerable.Empty<OrderStatusLog>();
    var statusEnum = SD.ParseOrderStatus(Model.OrderStatus);
    var isCancelled = Model.OrderStatus == SD.StatusCancelled;

    var steps = new[]
    {
        (SD.OrderStatus.Pending,    SD.StatusPending,    "Pendiente",  "bi-clock"),
        (SD.OrderStatus.Approved,   SD.StatusApproved,   "Pagado",     "bi-credit-card-2-front"),
        (SD.OrderStatus.Processing, SD.StatusInProcess,  "En Proceso", "bi-gear"),
        (SD.OrderStatus.Shipped,    SD.StatusShipped,    "Enviado",    "bi-truck"),
        (SD.OrderStatus.Delivered,  SD.StatusDelivered,  "Entregado",  "bi-check-circle"),
    };
}

<div class="container py-4">

    <!-- ── Header ───────────────────────────────────────── -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold mb-0">
                Pedido <span style="color: var(--accent-cyan);">#@Model.Id</span>
            </h2>
            <small class="text-muted">@Model.OrderDate.ToString("dddd, dd MMMM yyyy HH:mm")</small>
        </div>
        <a asp-action="Index" class="btn btn-outline-secondary rounded-pill">
            <i class="bi bi-arrow-left me-1"></i>Mis Pedidos
        </a>
    </div>

    <!-- ── Cancelled Alert ──────────────────────────────── -->
    @if (isCancelled)
    {
        <div class="alert d-flex align-items-center mb-4 rounded-3"
             style="background: rgba(220,53,69,0.1); border: 1px solid rgba(220,53,69,0.3); color: #f8d7da;">
            <i class="bi bi-x-circle-fill me-3 fs-4 text-danger"></i>
            <div>
                <strong>Pedido Cancelado.</strong>
                Si realizaste un pago, el reembolso se procesará en 5-10 días hábiles.
            </div>
        </div>
    }
    else
    {
        <!-- ── Progress Bar ──────────────────────────────── -->
        <div class="card border-0 shadow-sm mb-4" style="background: var(--bg-card); border: 1px solid var(--border-color) !important;">
            <div class="card-body py-4">
                <h6 class="text-muted mb-4 text-uppercase fw-semibold" style="font-size: 0.75rem; letter-spacing: 1px;">
                    Estado del Pedido
                </h6>

                <!-- Real-time notification -->
                <div id="realtime-alert" class="d-none mb-3 p-3 rounded-3 d-flex align-items-center"
                     style="background: rgba(0,212,255,0.1); border: 1px solid rgba(0,212,255,0.3);">
                    <i class="bi bi-lightning-charge-fill me-2" style="color: var(--accent-cyan);"></i>
                    <span id="realtime-message" style="color: var(--accent-cyan);">Conectando...</span>
                </div>

                <div class="d-flex justify-content-between align-items-start position-relative mb-2 overflow-x-auto pb-2 flex-nowrap"
                     style="scrollbar-width: none; -ms-overflow-style: none;">
                    <!-- Background line -->
                    <div class="position-absolute top-50 start-0 end-0 translate-middle-y d-none d-md-block"
                         style="height: 2px; background: var(--border-color); z-index: 0; margin: 0 50px;"></div>

                    @for (int i = 0; i < steps.Length; i++)
                    {
                        var (stepEnum, _, label, icon) = steps[i];
                        var isCompleted = (int)statusEnum >= (int)stepEnum;
                        var isCurrent = statusEnum == stepEnum;

                        var circleBg = isCompleted
                            ? "background: var(--accent-cyan); color: #0A0E1A;"
                            : "background: var(--bg-input); color: var(--text-muted); border: 1px solid var(--border-color);";
                        var textColor = isCompleted ? "color: var(--accent-cyan);" : "color: var(--text-muted);";
                        var glowStyle = isCurrent ? "box-shadow: 0 0 0 4px rgba(0,212,255,0.2);" : "";

                        <div class="d-flex flex-column align-items-center flex-shrink-0" style="z-index: 1; min-width: 100px;">
                            <div class="rounded-circle d-flex align-items-center justify-content-center"
                                 style="width: 48px; height: 48px; font-size: 1.2rem; @circleBg @glowStyle">
                                <i class="bi @icon"></i>
                            </div>
                            <small class="mt-2 text-center" style="font-size: 0.75rem; @textColor">@label</small>
                        </div>
                    }
                </div>
            </div>
        </div>
    }

    @if (statusLogs.Any())
    {
        <div class="card border-0 shadow-sm mb-4" style="background: var(--bg-card); border: 1px solid var(--border-color) !important;">
            <div class="card-header border-0 py-3" style="background: rgba(0,212,255,0.05); border-bottom: 1px solid var(--border-color) !important;">
                <h6 class="fw-bold mb-0" style="color: var(--accent-cyan);">
                    <i class="bi bi-clock-history me-2"></i>Historial de Estado
                </h6>
            </div>
            <div class="card-body">
                @foreach (var log in statusLogs)
                {
                    <div class="d-flex justify-content-between align-items-center py-2" style="border-bottom: 1px solid var(--border-color);">
                        <div>
                            <div class="fw-semibold" style="color: var(--text-primary);">
                                @SD.GetOrderStatusLabel(log.FromStatus) -> @SD.GetOrderStatusLabel(log.ToStatus)
                            </div>
                            <small class="text-muted">
                                @(string.IsNullOrWhiteSpace(log.ChangedBy) ? "Sistema" : log.ChangedBy)
                                @if (!string.IsNullOrWhiteSpace(log.Notes))
                                {
                                    <text> · @log.Notes</text>
                                }
                            </small>
                        </div>
                        <small class="text-muted">@log.ChangedAt.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</small>
                    </div>
                }
            </div>
        </div>
    }

    <div class="row g-4">
        <!-- ── Products ─────────────────────────────────── -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm" style="background: var(--bg-card); border: 1px solid var(--border-color) !important;">
                <div class="card-header border-0 py-3" style="background: rgba(0,212,255,0.05); border-bottom: 1px solid var(--border-color) !important;">
                    <h6 class="fw-bold mb-0" style="color: var(--accent-cyan);">
                        <i class="bi bi-box-seam me-2"></i>Productos
                    </h6>
                </div>
                <div class="card-body">
                    @foreach (var detail in orderDetails)
                    {
                        <div class="d-flex align-items-center py-3" style="border-bottom: 1px solid var(--border-color);">
                            <img src="@ImageUrlHelper.GetDisplayUrl(detail.Product?.ImageUrl, "https://via.placeholder.com/60")"
                                 width="60" height="60" class="rounded me-3" style="object-fit: cover; border: 1px solid var(--border-color);" />
                            <div class="flex-grow-1">
                                <div class="fw-semibold" style="color: var(--text-primary);">@detail.Product?.Name</div>
                                <small class="text-muted">Cantidad: @detail.Count</small>

                                @if (!string.IsNullOrEmpty(detail.SelectedOptions))
                                {
                                    var opts = System.Text.Json.JsonSerializer.Deserialize<List<dynamic>>(detail.SelectedOptions);
                                    <div class="mt-1">
                                        @foreach (var opt in opts!)
                                        {
                                            <span class="badge me-1" style="background: rgba(0,212,255,0.15); color: var(--accent-cyan); font-size: 0.7rem;">
                                                @opt.GetProperty("Name"): @opt.GetProperty("Value")
                                            </span>
                                        }
                                    </div>
                                }

                                @if (!string.IsNullOrEmpty(detail.SpecialNotes))
                                {
                                    <div class="mt-1 p-2 rounded" style="background: rgba(255,193,7,0.1); border-left: 3px solid #ffc107;">
                                        <small class="text-warning-emphasis">
                                            <i class="bi bi-sticky-fill me-1"></i>Nota: @detail.SpecialNotes
                                        </small>
                                    </div>
                                }
                            </div>
                            <div class="text-end ms-3">
                                <div class="fw-bold" style="color: var(--accent-cyan);">@((detail.Price * detail.Count).ToString("c"))</div>
                                <small class="text-muted">@detail.Price.ToString("c") c/u</small>
                            </div>
                        </div>
                    }
                    <div class="d-flex justify-content-between pt-3">
                        <strong style="color: var(--text-primary);">Total del Pedido</strong>
                        <strong style="color: var(--accent-cyan); font-size: 1.1rem;">@Model.OrderTotal.ToString("c")</strong>
                    </div>
                </div>
            </div>
        </div>

        <!-- ── Shipping Info ─────────────────────────────── -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm" style="background: var(--bg-card); border: 1px solid var(--border-color) !important;">
                <div class="card-header border-0 py-3" style="background: rgba(0,212,255,0.05); border-bottom: 1px solid var(--border-color) !important;">
                    <h6 class="fw-bold mb-0" style="color: var(--accent-cyan);">
                        <i class="bi bi-geo-alt me-2"></i>Información de Envío
                    </h6>
                </div>
                <div class="card-body">
                    <p class="mb-1 fw-semibold" style="color: var(--text-primary);">@Model.Name</p>
                    <p class="mb-1 text-muted">@Model.StreetAddress</p>
                    <p class="mb-1 text-muted">@Model.City, @Model.State @Model.PostalCode</p>
                    <p class="mb-0 text-muted"><i class="bi bi-telephone me-1"></i>@Model.PhoneNumber</p>

                    @if (!string.IsNullOrEmpty(Model.TrackingNumber))
                    {
                        <hr style="border-color: var(--border-color);" />
                        <p class="mb-1 text-muted small text-uppercase fw-semibold" style="letter-spacing: 1px;">Número de Rastreo</p>
                        <p class="fw-bold mb-1" style="color: var(--accent-cyan);">@Model.TrackingNumber</p>
                        <p class="mb-0 text-muted">Transportista: @Model.Carrier</p>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/lib/microsoft/signalr/dist/browser/signalr.min.js"></script>
    <script>
        const orderId = "@Model.Id";
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/hubs/orderStatus")
            .withAutomaticReconnect()
            .build();

        connection.on("OrderStatusUpdated", function (newStatus, newLabel, newIcon) {
            const alert = document.getElementById("realtime-alert");
            const msg = document.getElementById("realtime-message");
            if (alert && msg) {
                msg.textContent = `Estado actualizado: ${newLabel}`;
                alert.classList.remove("d-none");
                setTimeout(() => location.reload(), 2000);
            }
        });

        connection.start()
            .then(() => connection.invoke("SubscribeToOrder", orderId))
            .catch(err => console.error("SignalR error:", err));
    </script>
}
