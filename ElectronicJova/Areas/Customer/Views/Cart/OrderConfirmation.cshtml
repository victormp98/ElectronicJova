@using ElectronicJova.Models
@using ElectronicJova.Utilities
@model OrderHeader

@{
    ViewData["Title"] = "Confirmación de pedido";
}

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-12 col-md-8 col-lg-6 text-center">

            <!-- Success Icon with glow -->
            <div id="statusIcon" class="mb-4 no-print">
                <div class="d-inline-flex align-items-center justify-content-center rounded-circle mb-3 position-relative"
                     style="width: 100px; height: 100px; background: rgba(0, 212, 255, 0.05); border: 2px solid var(--border-accent);">
                    <div class="position-absolute w-100 h-100 rounded-circle" style="box-shadow: 0 0 30px var(--cyan-glow); animation: pulse-glow 2s infinite;"></div>
                    <i class="bi bi-hourglass-split display-4 text-warning position-relative z-1" id="statusIconEl"></i>
                </div>
            </div>

            <h1 class="fw-bold mb-2 text-light" id="statusTitle">¡Pedido realizado!</h1>
            <p class="mb-1 text-muted">Número de pedido: <strong class="text-info">#@Model.Id</strong></p>
            <p class="mb-4 text-muted">Recibirás una confirmación por correo electrónico.</p>

            <!-- Status Card -->
            <div class="card border-secondary mb-4 bg-card shadow-sm">
                <div class="card-body p-4 text-center">
                    <h5 class="fw-bold mb-3 text-light">Estado del pedido</h5>
                    <div id="orderStatusBadge" class="d-flex align-items-center justify-content-center gap-2">
                        <i class="bi @SD.GetOrderStatusIcon(Model.OrderStatus) fs-4 text-warning" id="statusBadgeIcon"></i>
                        <span class="badge bg-warning text-dark fs-6 px-3 py-2" id="statusBadgeText">
                            @SD.GetOrderStatusLabel(Model.OrderStatus)
                        </span>
                    </div>
                </div>
            </div>

            <div class="d-grid gap-2 d-sm-flex justify-content-sm-center no-print">
                <button onclick="window.print()" class="btn btn-outline-info px-4">
                    <i class="bi bi-printer me-2"></i>Imprimir Ticket
                </button>
                <a asp-area="Customer" asp-controller="Order" asp-action="Details" asp-route-id="@Model.Id"
                   class="btn btn-outline-secondary px-4">
                    <i class="bi bi-receipt me-2"></i>Ver detalle del pedido
                </a>
                <a asp-area="" asp-controller="Home" asp-action="Index" class="btn btn-primary px-4 shadow-info">
                    <i class="bi bi-house me-2"></i>Volver al inicio
                </a>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/lib/microsoft/signalr/dist/browser/signalr.min.js"></script>
    <script>
        $(document).ready(function () {
            const orderId = @Model.Id;

            const statusColors = {
                'Pending':    { badge: 'bg-warning text-dark', icon: 'text-warning' },
                'Approved':   { badge: 'bg-success text-white', icon: 'text-success' },
                'Processing': { badge: 'bg-info text-white',    icon: 'text-info' },
                'Shipped':    { badge: 'bg-primary text-white', icon: 'text-primary' },
                'Delivered':  { badge: 'bg-success text-white', icon: 'text-success' },
                'Cancelled':  { badge: 'bg-danger text-white',  icon: 'text-danger' }
            };

            const connection = new signalR.HubConnectionBuilder()
                .withUrl("/hubs/orderStatus")
                .withAutomaticReconnect()
                .build();

            connection.on("OrderStatusUpdated", function (status, label, iconClass) {
                const colors = statusColors[status] || { badge: 'bg-secondary text-white', icon: 'text-secondary' };

                // Update badge text and color
                $('#statusBadgeText')
                    .text(label)
                    .removeClass()
                    .addClass('badge fs-6 px-3 py-2 ' + colors.badge);

                // Update badge icon
                $('#statusBadgeIcon')
                    .removeClass()
                    .addClass('bi ' + iconClass + ' fs-4 ' + colors.icon);
                    
                // Update large icon
                $('#statusIconEl')
                    .removeClass()
                    .addClass('bi ' + iconClass + ' display-4 position-relative z-1 ' + colors.icon);

                // If delivered, update the main title
                if (status === 'Delivered') {
                    $('#statusTitle').text('¡Pedido entregado!');
                } else if (status === 'Approved') {
                    $('#statusTitle').text('¡Pago confirmado!');
                } else if (status === 'Cancelled') {
                    $('#statusTitle').text('Pedido cancelado').removeClass('text-success').addClass('text-danger');
                }
            });

            connection.start()
                .then(function () {
                    return connection.invoke("SubscribeToOrder", orderId.toString());
                })
                .catch(function (err) {
                    console.error("SignalR connection error:", err);
                });
        });
    </script>
    
    <style>
        @@keyframes pulse-glow {
            0% { box-shadow: 0 0 0 0 rgba(0, 212, 255, 0.4); }
            70% { box-shadow: 0 0 0 20px rgba(0, 212, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 212, 255, 0); }
        }
    </style>
}
