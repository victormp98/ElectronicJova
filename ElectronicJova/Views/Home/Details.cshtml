@using ElectronicJova.Models.ViewModels
@model DetailsVM

@{
    ViewData["Title"] = Model.Product!.Title;
}

<form method="post" asp-action="Details" class="bg-white">
    <input asp-for="Product.Id" hidden />
    <input asp-for="Product.ListPrice" hidden />

    <div class="container py-4">
        <div class="row">
            <!-- Product Image -->
            <div class="col-12 col-md-7 mb-4">
                <div class="p-3 border rounded bg-white text-center product-image-container position-relative">
                    <img src="@(string.IsNullOrEmpty(Model.Product!.ImageUrl) ? "https://via.placeholder.com/600x600?text=No+Image" : Model.Product.ImageUrl)" 
                         class="img-fluid rounded" alt="@Model.Product.Title" loading="lazy" style="max-height: 500px; object-fit: contain;" id="mainProductImage" />
                    
                    <button type="button" class="btn btn-white position-absolute top-0 end-0 m-3 rounded-circle shadow-sm" id="favoriteBtnImage" data-bs-toggle="tooltip" title="Guardar a favoritos">
                        <i class="bi @(Model.IsFavorite ? "bi-heart-fill text-danger" : "bi-heart text-danger") fs-4"></i>
                    </button>
                </div>
            </div>

            <!-- Product Info Side -->
            <div class="col-12 col-md-5">
                <div class="ps-md-4">
                    <span class="text-muted small mb-1 d-block">Nuevo</span>
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h2 class="fw-bold fs-3 text-dark mb-0">@Model.Product.Title</h2>
                        @* The original favorite button was here, but the instruction implies moving it or adding a new one in the image container.
                           Keeping the original button's ID for JS compatibility, but moving its functionality to the new button. *@
                        @* <button id="favoriteBtn" type="button" class="btn btn-link text-primary p-0" title="Favorito">
                            <i class="bi @(Model.IsFavorite ? "bi-heart-fill" : "bi-heart") fs-3"></i>
                        </button> *@
                    </div>
                    
                    <p class="text-secondary small mb-3">por <span class="text-primary">@Model.Product.Author</span></p>

                    <div class="mb-4">
                        @if (Model.Product.ListPrice > Model.Product.Price)
                        {
                            <span class="text-muted text-decoration-line-through fs-5">@Model.Product.ListPrice.ToString("c")</span>
                        }
                        <div class="d-flex align-items-center">
                            <h1 class="fw-bold text-dark me-2 mb-0" style="font-size: 2.5rem;">@Model.Product.Price.ToString("c")</h1>
                            @if (Model.Product.ListPrice > Model.Product.Price)
                            {
                                var discountPct = (int)Math.Round((1 - (double)Model.Product.Price / (double)Model.Product.ListPrice) * 100);
                                <span class="text-success fw-bold">@discountPct% OFF</span>
                            }
                        </div>
                    </div>

                    @if(Model.Product.Stock > 0)
                    {
                        <p class="text-dark fw-bold mb-1"><i class="bi bi-check-circle-fill text-success me-2"></i>Stock disponible</p>
                        <p class="text-muted small mb-3">Cantidad disponible: @Model.Product.Stock</p>
                    }
                    else
                    {
                        <p class="text-danger fw-bold mb-3"><i class="bi bi-x-circle-fill me-2"></i>Sin stock disponible</p>
                    }

                    <div class="mb-4">
                        <label asp-for="Count" class="form-label fw-bold text-dark">Cantidad:</label>
                        <div class="input-group" style="max-width: 150px;">
                            <input asp-for="Count" type="number" id="itemCount" class="form-control text-center shadow-none" value="1" min="1" max="@Model.Product.Stock" />
                        </div>
                    </div>

                    @if (Model.ProductOptions != null && Model.ProductOptions.Any())
                    {
                        <div class="mb-4 p-3 bg-light rounded border">
                            <h6 class="fw-bold text-dark mb-3">Personaliza tu producto</h6>
                            @foreach (var option in Model.ProductOptions.OrderBy(u => u.DisplayOrder))
                            {
                                <div class="form-check mb-2">
                                    <input class="form-check-input option-checkbox shadow-none" type="checkbox" 
                                           name="selectedOptions" value="@option.Id" 
                                           data-price="@(option.AdditionalPrice ?? 0)" 
                                           id="option_@option.Id" />
                                    <label class="form-check-label text-dark" for="option_@option.Id">
                                        @option.Name: @option.Value
                                        @if (option.AdditionalPrice > 0)
                                        {
                                            <span class="text-success small fw-bold">(+@option.AdditionalPrice.Value.ToString("c"))</span>
                                        }
                                    </label>
                                </div>
                            }
                        </div>
                    }

                    <div class="form-group mb-4">
                        <label for="specialNotes" class="form-label fw-bold text-dark">Notas especiales:</label>
                        <textarea class="form-control shadow-none" id="specialNotes" name="specialNotes" rows="2" placeholder="Ej: envolver para regalo..."></textarea>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg py-3 fw-bold shadow-sm">
                            <i class="bi bi-cart-plus me-2"></i>Agregar al carrito
                        </button>
                    </div>

                    <div class="mt-4 p-3 bg-opacity-10 bg-info rounded border border-info border-opacity-25">
                        <h6 class="fw-bold text-dark mb-1"><i class="bi bi-shield-check me-2"></i>Compra Protegida</h6>
                        <p class="text-muted small mb-0">Recibí el producto que esperabas o te devolvemos tu dinero.</p>
                    </div>
                </div>
            </div>
        </div>

        <hr class="my-5" />

        <div class="row">
            <div class="col-12 col-md-8">
                <h4 class="fw-bold text-dark mb-4">Descripción del producto</h4>
                <div class="text-secondary" style="white-space: pre-wrap; line-height: 1.6;">
                    @Model.Product.Description
                </div>
            </div>
        </div>
    </div>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        $(document).ready(function() {
            const basePrice = @Model.Product.Price;
            const priceDisplay = $('#totalPriceDisplay');
            const checkboxes = $('.option-checkbox');

            function updateTotal() {
                let extra = 0;
                checkboxes.filter(':checked').each(function() {
                    extra += parseFloat($(this).data('price')) || 0;
                });
                
                const total = basePrice + extra;
                priceDisplay.text(new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(total));
            }

            checkboxes.on('change', updateTotal);

            $('#favoriteBtnImage').click(function() {
                const btn = $(this);
                const icon = btn.find('i');
                const productId = @Model.Product.Id;

                $.post('/Customer/Wishlist/Toggle', { productId: productId }, function(response) {
                    if (response.success) {
                        if (response.action === 'added') {
                            btn.removeClass('btn-outline-light').addClass('btn-danger');
                            icon.removeClass('bi-heart').addClass('bi-heart-fill');
                            btn.attr('title', 'Quitar de favoritos');
                            toastr.success('Agregado a favoritos');
                        } else {
                            btn.removeClass('btn-danger').addClass('btn-outline-light');
                            icon.removeClass('bi-heart-fill').addClass('bi-heart');
                            btn.attr('title', 'Agregar a favoritos');
                            toastr.info('Quitado de favoritos');
                        }
                    } else {
                        // Si no está autenticado, el middleware de ASP.NET Core lo redirigirá o fallará el POST
                        // En aplicaciones reales, podrías manejar el status 401 explícitamente.
                        toastr.error('Debes iniciar sesión para usar favoritos');
                    }
                }).fail(function(xhr) {
                    if (xhr.status === 401) {
                         window.location.href = '/Identity/Account/Login?ReturnUrl=' + encodeURIComponent(window.location.pathname + window.location.search);
                    } else {
                        toastr.error('Error al procesar la solicitud');
                    }
                });
            });
        });
    </script>
}
