@using ElectronicJova.Models.ViewModels
@model DetailsVM

@{
    ViewData["Title"] = Model.Product!.Title;
}

<form method="post" asp-action="Details">
    <input asp-for="Product.Id" hidden />
    <input asp-for="Product.ListPrice" hidden /> @* Keep ListPrice for potential calculations later *@

    <div class="card shadow border-0 mt-4 mb-4">
        <div class="card-header bg-primary bg-gradient text-light ml-0 py-4">
            <div class="row">
                <div class="col-12 text-center">
                    <div class="d-flex justify-content-center align-items-center mb-1">
                        <h3 class="text-white mb-0 me-3">@Model.Product.Title</h3>
                        <button id="favoriteBtn" class="btn @(Model.IsFavorite ? "btn-danger" : "btn-outline-light") rounded-circle" 
                                style="width: 45px; height: 45px; transition: all 0.3s ease;" 
                                title="@(Model.IsFavorite ? "Quitar de favoritos" : "Agregar a favoritos")">
                            <i class="bi @(Model.IsFavorite ? "bi-heart-fill" : "bi-heart") fs-4"></i>
                        </button>
                    </div>
                    <p class="text-white-50 fw-semibold mb-0">by @Model.Product.Author</p>
                    @if(Model.Product.Stock > 0)
                    {
                        <span class="badge bg-success mt-2">In Stock: @Model.Product.Stock</span>
                    }
                    else
                    {
                        <span class="badge bg-danger mt-2">Out of Stock</span>
                    }
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="container rounded p-2">
                <div class="row">
                    <div class="col-12 col-lg-4 text-center mb-4 mb-lg-0 order-1 order-lg-2">
                        <img src="@(string.IsNullOrEmpty(Model.Product!.ImageUrl) ? "https://via.placeholder.com/300x400?text=No+Image" : Model.Product.ImageUrl)" width="100%" class="rounded shadow-sm" loading="lazy" style="max-width: 400px;" />
                    </div>
                    <div class="col-12 col-lg-8 order-2 order-lg-1">
                        <div class="row">
                            <div class="col-12">
                                <p class="text-primary fw-bold">ISBN: @Model.Product.ISBN</p>
                                <p class="text-secondary">@Model.Product.Description</p>
                                
                                <div class="row border-bottom py-2">
                                    <div class="col-6 col-md-3 text-primary">
                                        <h5 class="mb-0">List Price:</h5>
                                    </div>
                                    <div class="col-6 col-md-9 text-primary text-end text-md-start">
                                        <h5 class="mb-0"><s class="text-secondary">@Model.Product.ListPrice.ToString("c")</s></h5>
                                    </div>
                                </div>
                                <div class="row border-bottom py-2 bg-light">
                                    <div class="col-6 col-md-3 text-primary">
                                        <h5 class="mb-0 fw-bold">Price:</h5>
                                    </div>
                                    <div class="col-6 col-md-9 text-primary text-end text-md-start">
                                        <h5 class="mb-0 fw-bold">@Model.Product.Price.ToString("c")</h5>
                                    </div>
                                </div>
                                <div class="row border-bottom py-2">
                                    <div class="col-6 col-md-3 text-primary">
                                        <h5 class="mb-0">Price 50+:</h5>
                                    </div>
                                    <div class="col-6 col-md-9 text-primary text-end text-md-start">
                                        <h5 class="mb-0">@Model.Product.Price50.ToString("c")</h5>
                                    </div>
                                </div>
                                <div class="row border-bottom py-2">
                                    <div class="col-6 col-md-3 text-primary">
                                        <h5 class="mb-0">Price 100+:</h5>
                                    </div>
                                    <div class="col-6 col-md-9 text-primary text-end text-md-start">
                                        <h5 class="mb-0">@Model.Product.Price100.ToString("c")</h5>
                                    </div>
                                </div>

                                <div class="row my-4 align-items-center">
                                    <div class="col-4 col-md-3 text-primary">
                                        <h5 class="mb-0 fw-bold">Count:</h5>
                                    </div>
                                    <div class="col-8 col-md-9">
                                        <input asp-for="Count" type="number" id="itemCount" class="form-control form-control-lg border-primary border-opacity-25" />
                                        <span asp-validation-for="Count" class="text-danger"></span>
                                    </div>
                                </div>

                                @if (Model.ProductOptions != null && Model.ProductOptions.Any())
                                {
                                    <div class="card mt-3 border-0 shadow-sm border-start border-primary border-4">
                                        <div class="card-header bg-light">
                                            <h5 class="mb-0 text-primary">Personaliza tu producto</h5>
                                        </div>
                                        <div class="card-body">
                                            @foreach (var option in Model.ProductOptions.OrderBy(u => u.DisplayOrder))
                                            {
                                                <div class="form-check mb-3 py-1">
                                                    <input class="form-check-input option-checkbox" type="checkbox" 
                                                           name="selectedOptions" value="@option.Id" 
                                                           data-price="@(option.AdditionalPrice ?? 0)" 
                                                           id="option_@option.Id" 
                                                           style="width: 1.25rem; height: 1.25rem;" />
                                                    <label class="form-check-label ms-2 pt-1" for="option_@option.Id">
                                                        @option.Name: @option.Value
                                                        @if (option.AdditionalPrice > 0)
                                                        {
                                                            <span class="text-success fw-bold">(+@option.AdditionalPrice.Value.ToString("c"))</span>
                                                        }
                                                    </label>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                }

                                <div class="form-group mt-3">
                                    <label for="specialNotes" class="text-primary fw-bold mb-2">Notas especiales (opcional)</label>
                                    <textarea class="form-control pt-2" id="specialNotes" name="specialNotes" rows="3" placeholder="Ej: Incluir factura, regalo, instrucciones..."></textarea>
                                </div>

                                <div class="mt-4 p-4 bg-primary bg-opacity-10 rounded text-center text-md-end border border-primary border-opacity-25 shadow-sm">
                                    <h5 class="text-muted small mb-1">Precio Total Estimado:</h5>
                                    <h1 class="text-primary fw-bold mb-0" id="totalPriceDisplay">@Model.Product.Price.ToString("c")</h1>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-footer bg-white border-0 py-4">
            <div class="row">
                <div class="col-12 col-md-6 mb-3 mb-md-0">
                    <a asp-action="Index" class="btn btn-outline-primary btn-lg w-100 rounded-pill py-3">
                        <i class="bi bi-arrow-left me-2"></i>Back to Home
                    </a>
                </div>
                <div class="col-12 col-md-6">
                    <button type="submit" class="btn btn-primary bg-gradient btn-lg w-100 rounded-pill py-3 shadow">
                        <i class="bi bi-cart-plus me-2"></i>Add to Cart
                    </button>
                </div>
            </div>
        </div>
    </div>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        $(document).ready(function() {
            const basePrice = @Model.Product.Price;
            const priceDisplay = $('#totalPriceDisplay');
            const checkboxes = $('.option-checkbox');

            function updateTotal() {
                let extra = 0;
                checkboxes.filter(':checked').each(function() {
                    extra += parseFloat($(this).data('price')) || 0;
                });
                
                const total = basePrice + extra;
                priceDisplay.text(new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(total));
            }

            checkboxes.on('change', updateTotal);

            $('#favoriteBtn').click(function() {
                const btn = $(this);
                const icon = btn.find('i');
                const productId = @Model.Product.Id;

                $.post('/Customer/Wishlist/Toggle', { productId: productId }, function(response) {
                    if (response.success) {
                        if (response.action === 'added') {
                            btn.removeClass('btn-outline-light').addClass('btn-danger');
                            icon.removeClass('bi-heart').addClass('bi-heart-fill');
                            btn.attr('title', 'Quitar de favoritos');
                            toastr.success('Agregado a favoritos');
                        } else {
                            btn.removeClass('btn-danger').addClass('btn-outline-light');
                            icon.removeClass('bi-heart-fill').addClass('bi-heart');
                            btn.attr('title', 'Agregar a favoritos');
                            toastr.info('Quitado de favoritos');
                        }
                    } else {
                        // Si no está autenticado, el middleware de ASP.NET Core lo redirigirá o fallará el POST
                        // En aplicaciones reales, podrías manejar el status 401 explícitamente.
                        toastr.error('Debes iniciar sesión para usar favoritos');
                    }
                }).fail(function(xhr) {
                    if (xhr.status === 401) {
                         window.location.href = '/Identity/Account/Login?ReturnUrl=' + encodeURIComponent(window.location.pathname + window.location.search);
                    } else {
                        toastr.error('Error al procesar la solicitud');
                    }
                });
            });
        });
    </script>
}
