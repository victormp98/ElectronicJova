@using ElectronicJova.Models.ViewModels
@model DetailsVM

@{
    ViewData["Title"] = Model.Product!.Name;
    var hasDiscount = Model.Product.ListPrice > Model.Product.Price;
    var discountPct = hasDiscount
        ? (int)Math.Round((1 - (double)Model.Product.Price / (double)Model.Product.ListPrice) * 100)
        : 0;
    var inStock = Model.Product.Stock > 0;
}

<form method="post" asp-action="Details">
    <input asp-for="Product.Id" hidden />
    <input asp-for="Product.ListPrice" hidden />

    <div class="container py-5">
        <div class="row g-4">

            <!-- ── Product Image ──────────────────────── -->
            <div class="col-12 col-md-7">
                <div class="card p-3 p-md-5 h-100 d-flex align-items-center justify-content-center position-relative border-0 shadow-sm" style="background: var(--bg-card);">
                    
                    <!-- Badges -->
                    <div class="position-absolute top-0 start-0 m-3 d-flex flex-column gap-2 z-2">
                        @if (!inStock)
                        {
                            <span class="badge bg-danger rounded-pill px-3 py-2">Agotado</span>
                        }
                        else if (Model.Product.Stock < 5)
                        {
                            <span class="badge bg-warning rounded-pill px-3 py-2 text-dark">
                                <i class="bi bi-exclamation-triangle-fill me-1"></i>¡Últimas unidades!
                            </span>
                        }
                        @if (hasDiscount)
                        {
                            <span class="badge bg-success rounded-pill px-3 py-2">
                                -@discountPct% OFF
                            </span>
                        }
                    </div>

                    <!-- Favorite Button (Hidden for Admin) -->
                    @if (!User.IsInRole(SD.Role_Admin))
                    {
                        <button type="button"
                                class="position-absolute top-0 end-0 m-3 btn btn-secondary rounded-circle d-flex align-items-center justify-content-center p-0"
                                id="favoriteBtnImage"
                                data-bs-toggle="tooltip"
                                title="@(Model.IsFavorite ? "Quitar de favoritos" : "Guardar en favoritos")"
                                style="width: 45px; height: 45px; z-index: 2;">
                            <i class="bi @(Model.IsFavorite ? "bi-heart-fill" : "bi-heart") fs-5 text-danger"></i>
                        </button>
                    }

                    <img src="@ImageUrlHelper.GetDisplayUrl(Model.Product!.ImageUrl, "https://via.placeholder.com/600x600?text=No+Image")"
                         class="img-fluid rounded"
                         alt="@Model.Product.Name"
                         loading="lazy"
                         id="mainProductImage"
                         style="max-height: 500px; object-fit: contain;" />
                </div>
            </div>

            <!-- ── Product Info ────────────────────────── -->
            <div class="col-12 col-md-5">
                <div class="h-100 d-flex flex-column gap-3">

                    <!-- Condition Badge -->
                    <div>
                        <span class="badge bg-info bg-opacity-10 text-info border border-info rounded-pill px-3 py-1">
                            <i class="bi bi-lightning-charge-fill me-1"></i>NUEVO
                        </span>
                    </div>

                     <!-- Header -->
                     <div>
                         <h1 class="fw-bold mb-1 text-light display-6">@Model.Product.Name</h1>
                         <p class="text-muted mb-0">
                             Modelo: <span class="text-info fw-semibold">@Model.Product.Model</span> | 
                             Marca: <span class="text-info fw-semibold">@Model.Product.Brand</span>
                         </p>
                     </div>

                    <!-- Price Card -->
                    <div class="card p-4 border-0 bg-opacity-50" style="background: rgba(0,0,0,0.2);">
                        @if (hasDiscount)
                        {
                            <span class="text-decoration-line-through text-muted small">
                                @Model.Product.ListPrice.ToString("c") (Precio de Lista)
                            </span>
                        }
                        <div class="d-flex align-items-center gap-3">
                            <span id="totalPriceDisplay" class="display-4 fw-bold text-info" style="font-size: 2.5rem; text-shadow: 0 0 15px rgba(0, 212, 255, 0.3);">
                                @Model.Product.Price.ToString("c")
                            </span>
                        </div>
                        
                        <!-- Pricing Table for Clarity -->
                        <div class="mt-3">
                            <h6 class="text-light fw-bold small text-uppercase mb-2">Descuentos por volumen:</h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-dark table-borderless mb-0" style="font-size: 0.85rem;">
                                    <tbody>
                                        <tr>
                                            <td class="text-muted">1-50 unidades</td>
                                            <td class="text-info fw-bold text-end">@Model.Product.Price.ToString("c")</td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">51-100 unidades</td>
                                            <td class="text-info fw-bold text-end">@Model.Product.Price50.ToString("c")</td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">+100 unidades</td>
                                            <td class="text-info fw-bold text-end">@Model.Product.Price100.ToString("c")</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="mt-3 text-muted small">
                            <i class="bi bi-credit-card-2-front me-1"></i>Pago seguro con Stripe
                        </div>
                    </div>

                    <!-- Stock Status -->
                    <div>
                        @if (inStock)
                        {
                            <p class="text-success fw-semibold mb-1">
                                <i class="bi bi-check-circle-fill me-2"></i>Stock disponible
                            </p>
                            <small class="text-muted">@Model.Product.Stock unidades disponibles</small>
                        }
                        else
                        {
                            <p class="text-danger fw-semibold mb-0">
                                <i class="bi bi-x-circle-fill me-2"></i>Sin stock disponible
                            </p>
                        }
                    </div>

                    <!-- Quantity (Hidden for Admin) -->
                    @if (!User.IsInRole(SD.Role_Admin))
                    {
                        <div class="mb-3">
                            <label asp-for="Count" class="form-label text-muted fw-semibold">Cantidad:</label>
                            <div class="input-group" style="width: 150px;">
                                <button type="button" class="btn btn-outline-secondary" id="btnMinus"><i class="bi bi-dash"></i></button>
                                <input asp-for="Count" type="number" id="itemCount" class="form-control text-center fw-bold bg-dark text-light border-secondary" value="1" min="1" max="@Model.Product.Stock" onkeydown="return false;" />
                                <button type="button" class="btn btn-outline-secondary" id="btnPlus"><i class="bi bi-plus"></i></button>
                            </div>
                        </div>
                    }

                    <!-- Options -->
                    @if (Model.ProductOptions != null && Model.ProductOptions.Any())
                    {
                        <div class="card p-3 border-secondary mb-3">
                            <h6 class="fw-bold mb-3 text-light">
                                <i class="bi bi-sliders me-2 text-info"></i>Personaliza tu producto
                            </h6>
                            @foreach (var option in Model.ProductOptions.OrderBy(u => u.DisplayOrder))
                            {
                                <div class="form-check mb-2">
                                    <input class="form-check-input option-checkbox" type="checkbox"
                                           name="selectedOptions" value="@option.Id"
                                           data-price="@(option.AdditionalPrice ?? 0)"
                                           id="option_@option.Id" />
                                    <label class="form-check-label text-light" for="option_@option.Id">
                                        @option.Name: <span class="fw-bold">@option.Value</span>
                                        @if (option.AdditionalPrice > 0)
                                        {
                                            <span class="badge bg-success ms-2">+@option.AdditionalPrice.Value.ToString("c")</span>
                                        }
                                    </label>
                                </div>
                            }
                        </div>
                    }

                    <!-- Special Notes -->
                    <div class="mb-4">
                        <label for="specialNotes" class="form-label text-muted small fw-semibold">
                            <i class="bi bi-pencil me-1"></i>NOTAS ESPECIALES
                        </label>
                        <textarea class="form-control bg-dark text-light border-secondary" id="specialNotes" name="specialNotes" rows="2" placeholder="Ej: Envolver para regalo..."></textarea>
                    </div>

                    <!-- Action Buttons -->
                    @if (User.IsInRole(SD.Role_Admin))
                    {
                        <div class="alert alert-info border-info bg-opacity-10 d-flex align-items-center rounded-3 p-3">
                            <i class="bi bi-shield-lock-fill fs-4 me-3 text-info"></i>
                            <div>
                                <h6 class="mb-1 fw-bold text-info text-uppercase" style="font-size: 0.8rem; letter-spacing: 1px;">Modo Administrador</h6>
                                <p class="mb-0 small text-light opacity-75">Las funciones de compra están deshabilitadas para usuarios administrativos.</p>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg py-3 fw-bold text-uppercase shadow-info" @(!inStock ? "disabled" : "")>
                                <i class="bi bi-cart-plus me-2"></i>Añadir al Carrito
                            </button>
                            <button type="button" id="btnBuyNow" class="btn btn-outline-info btn-lg py-3 fw-bold text-uppercase shadow-sm" @(!inStock ? "disabled" : "")>
                                <i class="bi bi-lightning-fill me-2"></i>Comprar Ahora
                            </button>
                        </div>
                    }

                    <!-- Assurance -->
                    <div class="d-flex align-items-center gap-3 p-3 rounded mt-3" style="background: rgba(0, 200, 150, 0.05); border: 1px solid rgba(0, 200, 150, 0.2);">
                        <i class="bi bi-shield-check-fill fs-3 text-success"></i>
                        <div>
                            <div class="text-success fw-bold small">Compra Protegida</div>
                            <div class="text-muted small" style="font-size: 0.75rem; line-height: 1.2;">Recibí el producto que esperabas o te devolvemos tu dinero.</div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <div class="section-divider my-5"></div>

         <!-- ── Technical Info ─────────────────────────── -->
         <div class="row mt-4">
             <div class="col-12 col-lg-6 mb-4">
                 <h3 class="fw-bold mb-4 text-light">
                     <i class="bi bi-gear-fill me-2 text-info"></i>Especificaciones
                 </h3>
                 <div class="text-light opacity-75" style="white-space: pre-wrap; line-height: 1.8;">
                     @(string.IsNullOrEmpty(Model.Product.Specifications) ? "No hay especificaciones técnicas disponibles." : Model.Product.Specifications)
                 </div>
             </div>
             <div class="col-12 col-lg-6 mb-4">
                 <h3 class="fw-bold mb-4 text-light">
                     <i class="bi bi-shield-check me-2 text-info"></i>Garantía
                 </h3>
                 <div class="text-light opacity-75" style="white-space: pre-wrap; line-height: 1.8;">
                     @(string.IsNullOrEmpty(Model.Product.Warranty) ? "Consulte los términos de garantía con el fabricante." : Model.Product.Warranty)
                 </div>
             </div>
         </div>

         <!-- ── Description ─────────────────────────────────── -->
         <div class="row mt-4">
             <div class="col-12">
                 <h3 class="fw-bold mb-4 text-light">
                     <i class="bi bi-file-text me-2 text-info"></i>Descripción del producto
                 </h3>
                 <div class="text-light opacity-75" style="white-space: pre-wrap; line-height: 1.8;">
                     @Model.Product.Description
                 </div>
             </div>
         </div>
    </div>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        $(document).ready(function () {
            const toggleFavoriteUrl = '@Url.Action("Toggle", "Wishlist", new { area = "Customer" })';
            const basePrice = @Model.Product.Price;
            const priceDisplay = $('#totalPriceDisplay');
            const checkboxes = $('.option-checkbox');
            const itemCount = $('#itemCount');
            const maxStock = @Model.Product.Stock;

            // ── Quantity +/- buttons ──────────────────────
            $('#btnMinus').click(function () {
                let v = parseInt(itemCount.val()) || 1;
                if (v > 1) itemCount.val(v - 1).trigger('change');
            });
            $('#btnPlus').click(function () {
                let v = parseInt(itemCount.val()) || 1;
                if (v < maxStock) itemCount.val(v + 1).trigger('change');
            });

            // ── Price update with options ─────────────────
            function updateTotal() {
                let extra = 0;
                checkboxes.filter(':checked').each(function () {
                    extra += parseFloat($(this).data('price')) || 0;
                });
                const total = basePrice + extra;
                priceDisplay.text(new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(total));
            }
            checkboxes.on('change', updateTotal);

            // ── Buy Now ──────────────────────────────────
            $('#btnBuyNow').click(function() {
                const form = $(this).closest('form');
                
                // Submit via AJAX so we can redirect after
                $.ajax({
                    url: form.attr('action'),
                    type: 'POST',
                    data: form.serialize(),
                    success: function() {
                        window.location.href = '@Url.Action("Index", "Cart", new { area = "Customer" })';
                    },
                    error: function() {
                        toastr.error('Error al procesar la compra. Intente de nuevo.');
                    }
                });
            });

            // ── Favorite toggle ───────────────────────────
            $('#favoriteBtnImage').click(function () {
                const btn = $(this);
                const icon = btn.find('i');
                const productId = @Model.Product.Id;

                $.post(toggleFavoriteUrl, { productId: productId }, function (response) {
                    if (response.success) {
                        if (response.action === 'added') {
                            icon.removeClass('bi-heart').addClass('bi-heart-fill');
                            btn.attr('title', 'Quitar de favoritos');
                            toastr.success('Agregado a favoritos');
                        } else {
                            icon.removeClass('bi-heart-fill').addClass('bi-heart');
                            btn.attr('title', 'Guardar en favoritos');
                            toastr.info('Quitado de favoritos');
                        }
                    } else {
                        toastr.error('Debes iniciar sesión para usar favoritos');
                    }
                }).fail(function (xhr) {
                    if (xhr.status === 401) {
                        window.location.href = '/Identity/Account/Login?ReturnUrl=' + encodeURIComponent(window.location.pathname + window.location.search);
                    } else {
                        toastr.error('Error al procesar la solicitud');
                    }
                });
            });
        });
    </script>
}
